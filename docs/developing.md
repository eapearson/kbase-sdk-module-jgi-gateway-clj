# Developing

When developing a Clojure server, it is much faster to iterate over a locally running json-rpc server. There are specific Clojure workflows which utilize automatic recompilation and class loading upon recompilation which will make the iterative development process much faster than working against the dynamic service, a local docker deploy, or even a local docker simulation.

## Local Fast-Dev Setup

All that is needed for the service to operate in json-rpc mode is the configuration file. As a better simulation of deployment in the sdk environment, the config file should be generated by the module itself.

In any case, the server is started like so

```
export KB_DEPLOYMENT_CONFIG=`pwd`/deploy.cfg
export KB_SERVICE_NAME=jgi_gateway_clj
lein with-profile dev ring server-headless
```

In the ui, you will just need to ensure that the service config flags the service as non-dynamic, and supply the local endpoint.

### Proxying

If the service is being operated within a ui served over https, the service endpoint will need to be https. The service itself operates over http, running behind a secure proxy in a deployment. We must simulate that, but fortunately it is a simple vagrant setup.

install vagrant vm

```
vagrant init ubuntu/trusty64
```

set up Vagrantfile

```
vi Vagrantfile
```

towards the bottom of the file add this, above the final "end", add this:

```
    config.vm.synced_folder "../jgi_gateway_clj/clojure/server", "/vagrant/jgi-gateway", type: "nfs"
    config.vm.synced_folder "../kbase-ui/build/build/client", "/vagrant/kbase-ui", type: "nfs"
    # config.vm.synced_folder ".", "/vagrant", type: "nfs"
    config.vm.network "private_network", type: "dhcp"
    config.vm.provider "virtualbox" do |vb|
        vb.gui = false
        vb.memory = 2048
        vb.customize ["setextradata", :id, "VBoxInternal2/SharedFoldersEnableSymlinksCreate/vagrant", "1"]
    end
```

One more additional task, to adjust the nfs on the host?

#### install dependencies
    - jdk 8
    - nginx

```
vagrant ssh
sudo su
add-apt-repository ppa:nginx/stable
add-apt-repository ppa:openjdk-r/ppa
apt-get update
apt-get upgrade -y
apt-get dist-upgrade -y
apt-get autoremove -y
apt-get install nginx-extras openjdk-8-jdk -y
```

> Note: this is not an environment for kbase-ui integration too. It is certainly possible to combine this workflow with kbase-ui workflow into one VM. However, this configuration allows the VM to operate independently of the client - e.g. you can use it to develop with a local Narrative as well, or with other client dev workflows like testing, prototyping.

#### install self-signed ssl certificate

The location of the cert is not important, only that it match the location in the ngxin config we'll install in a minute.

```
cd /vagrant
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout test.key -out test.crt
```

Openssl will prompt for certificate information. It doesn't really matter what you enter here:

```text
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:California
Locality Name (eg, city) []:Berkeley
Organization Name (eg, company) [Internet Widgits Pty Ltd]:LBNL
Organizational Unit Name (eg, section) []:KBase
Common Name (e.g. server FQDN or YOUR name) []:ci.kbase.us
Email Address []:
```

#### Install the nginx config

We are going to edit that file, erase the contents, and insert our config. E.g.

```text
vi /etc/nginx/sites-available/default
:1,$d
i
```

copy this 

```text
#  redirect accidental insecure requests to https
server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name dev.kbase.us;
  return 301 https://ci.kbase.us$request_uri;
}
server {
  listen 443 ssl;
  server_name ci.kbase.us;
  ssl_certificate /vagrant/test.crt;
  ssl_certificate_key /vagrant/test.key;
  # Proxy all service call to the real CI
  # nb the proxie_cookie_path is for the auth service
  # could be a separate location at /services/auth
  location /services {
    proxy_cookie_path /login /services/auth/login;
    proxy_cookie_path /link /services/auth/link;
    proxy_pass https://ci.kbase.us/services;
  }
  location /dynserv {
    proxy_pass https://ci.kbase.us/dynserv;
  }
  location /geonames {
     proxy_pass http://api.geonames.org/;
  }
  # Proxy the narrative including websockets
  location /narrative {
    proxy_pass https://ci.kbase.us/narrative;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
  # Proxy all non-services to the local kbase-ui running in the vm
  location / {
    # next line for node testing server.
    root /vagrant/kbase-ui/build/build/client;
    index index.html;
  }
}
```